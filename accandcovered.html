<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acc & Covered Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .report-table {
            margin-top: 20px;
        }

        .highlight-acc {
            background-color: #85f19e;
        }

        .highlight-covered {
            background-color: #f1d06e;
        }

        .checkbox-column {
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">KJRateFix</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="entry.html">Entry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="viewdata.html">View Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="accandcovered.html">Covered</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="text-center">Orders with Acc and Covered Checked</h2>
        <div id="accCoveredTable" class="report-table">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Weight</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th class="checkbox-column">Acc</th>
                        <th class="checkbox-column">Covered</th>
                    </tr>
                </thead>
                <tbody id="accCoveredReportBody">
                    <!-- Data rows will be added dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAFr9vK3MbujpR9KFe_UsKHHCtedsYj26A",
            authDomain: "kjratefixweb.firebaseapp.com",
            databaseURL: "https://kjratefixweb-default-rtdb.firebaseio.com",
            projectId: "kjratefixweb",
            storageBucket: "kjratefixweb.firebasestorage.app",
            messagingSenderId: "854761320925",
            appId: "1:854761320925:web:1a48cc618d83f7e4b34634"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const accCoveredReportBody = document.getElementById('accCoveredReportBody');

        async function fetchAccCoveredOrders() {
            try {
                // Fetch all orders with both checkboxes checked (Acc and Covered)
                const ordersQuery = query(
                    collection(db, "orders"),
                    where("accChecked", "==", true),
                    where("coveredChecked", "==", true)
                );

                const querySnapshot = await getDocs(ordersQuery);

                if (querySnapshot.empty) {
                    alert("No orders found with both Acc and Covered checked.");
                    return;
                }

                accCoveredReportBody.innerHTML = '';

                querySnapshot.forEach(doc => {
                    const orderData = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${orderData.timestamp.toDate().toLocaleDateString()}</td>
                        <td>${orderData.name}</td>
                        <td>${orderData.weight}</td>
                        <td>${orderData.rate}</td>
                        <td>${orderData.amount}</td>
                        <td class="checkbox-column">
                            <input type="checkbox" class="acc-checkbox" id="acc-${doc.id}" ${orderData.accChecked ? 'checked' : ''} />
                        </td>
                        <td class="checkbox-column">
                            <input type="checkbox" class="covered-checkbox" id="covered-${doc.id}" ${orderData.coveredChecked ? 'checked' : ''} />
                        </td>
                    `;
                    accCoveredReportBody.appendChild(row);

                    // Handle checkbox state change for highlighting and Firebase update
                    const accCheckbox = row.querySelector('.acc-checkbox');
                    const coveredCheckbox = row.querySelector('.covered-checkbox');

                    accCheckbox.addEventListener('change', function () {
                        handleCheckboxChange(doc.id, 'accChecked', accCheckbox);
                        if (accCheckbox.checked) {
                            row.classList.add('highlight-acc');
                        } else {
                            row.classList.remove('highlight-acc');
                        }
                    });

                    coveredCheckbox.addEventListener('change', function () {
                        handleCheckboxChange(doc.id, 'coveredChecked', coveredCheckbox);
                        if (coveredCheckbox.checked) {
                            row.classList.add('highlight-covered');
                        } else {
                            row.classList.remove('highlight-covered');
                        }
                    });

                    // Apply highlight for checked checkboxes on initial page load
                    if (accCheckbox.checked) {
                        row.classList.add('highlight-acc');
                    }
                    if (coveredCheckbox.checked) {
                        row.classList.add('highlight-covered');
                    }
                });

            } catch (error) {
                console.error("Error fetching Acc and Covered orders: ", error);
                alert("There was an error fetching the orders.");
            }
        }

        async function handleCheckboxChange(docId, field, checkbox) {
            const orderRef = doc(db, "orders", docId);
            await updateDoc(orderRef, {
                [field]: checkbox.checked
            });
        }

        // Call the function when the page loads
        fetchAccCoveredOrders();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
