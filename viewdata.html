<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJRateFix - View Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .btn {
            margin-top: 20px;
        }

        .checkbox-column {
            text-align: center;
        }

        .highlight-acc {
            background-color: #85f19e;
        }

        .highlight-covered {
            background-color: #f1d06e;
        }

        #averagesDisplay, #totalAverages {
            margin-top: 20px;
        }

        .averages-column {
            display: flex;
            justify-content: space-between;
        }

        .averages-column div {
            width: 45%;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">KJRateFix</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="entry.html">Entry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="viewdata.html">View Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="accandcovered.html">Covered</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="text-center mt-4">Generate Report</h2>
        <form id="dateForm">
            <div class="row mb-3">
                <div class="col-12 col-md-6">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" required>
                </div>
                <div class="col-12 col-md-6">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" required>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="btnGenerateReport">Generate Report</button>

            <!-- Display Total Averages -->
            <div id="totalAverages" class="mt-3" style="display: none;">
                <div class="averages-column">
                    <!-- Positive averages column -->
                    <div>
                        <h6>Positive Averages:</h6>
                        <p><strong>Total Average Weight:</strong> <span id="totalAvgWeightPositive">N/A</span></p>
                        <p><strong>Total Average Amount:</strong> <span id="totalAvgAmountPositive">N/A</span></p>
                    </div>

                    <!-- Negative averages column -->
                    <div>
                        <h6>Negative Averages:</h6>
                        <p><strong>Total Average Weight:</strong> <span id="totalAvgWeightNegative">N/A</span></p>
                        <p><strong>Total Average Amount:</strong> <span id="totalAvgAmountNegative">N/A</span></p>
                    </div>
                </div>
            </div>
        </form>

        <div id="reportTable" class="report-table" style="display:none;">
            <h3 class="text-center mt-4">Orders Report</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Weight</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th class="checkbox-column">Acc</th>
                            <th class="checkbox-column">Covered</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody">
                        <!-- Data rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAFr9vK3MbujpR9KFe_UsKHHCtedsYj26A",
            authDomain: "kjratefixweb.firebaseapp.com",
            databaseURL: "https://kjratefixweb-default-rtdb.firebaseio.com",
            projectId: "kjratefixweb",
            storageBucket: "kjratefixweb.firebasestorage.app",
            messagingSenderId: "854761320925",
            appId: "1:854761320925:web:1a48cc618d83f7e4b34634"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const btnGenerateReport = document.getElementById('btnGenerateReport');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const reportTable = document.getElementById('reportTable');
        const reportBody = document.getElementById('reportBody');

        // Set current date as default for both start and end date
        const today = new Date().toISOString().split('T')[0];
        startDateInput.value = today;
        endDateInput.value = today;

        btnGenerateReport.addEventListener('click', function () {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                alert("Please select both start and end dates.");
                return;
            }

            fetchData(startDate, endDate);
        });

        function displayTotalAverages(filteredOrders) {
            let totalWeightPositive = 0;
            let totalAmountPositive = 0;
            let totalWeightNegative = 0;
            let totalAmountNegative = 0;

            let countPositive = 0;
            let countNegative = 0;

            filteredOrders.forEach(order => {
                if (!(order.accChecked && order.coveredChecked)) {
                    // Check if the order's Weight and Amount are positive or negative
                    if (order.weight > 0 && order.amount > 0) {
                        totalWeightPositive += order.weight;
                        totalAmountPositive += order.amount;
                        countPositive++;
                    } else if (order.weight < 0 && order.amount < 0) {
                        totalWeightNegative += order.weight;
                        totalAmountNegative += order.amount;
                        countNegative++;
                    }
                }
            });

            // Calculate positive averages
            const avgWeightPositive = countPositive > 0 ? (totalWeightPositive / countPositive).toFixed(2) : "N/A";
            const avgAmountPositive = countPositive > 0 ? (totalAmountPositive / countPositive).toFixed(2) : "N/A";

            // Calculate negative averages
            const avgWeightNegative = countNegative > 0 ? (totalWeightNegative / countNegative).toFixed(2) : "N/A";
            const avgAmountNegative = countNegative > 0 ? (totalAmountNegative / countNegative).toFixed(2) : "N/A";

            // Display averages
            document.getElementById('totalAvgWeightPositive').textContent = avgWeightPositive;
            document.getElementById('totalAvgAmountPositive').textContent = avgAmountPositive;

            document.getElementById('totalAvgWeightNegative').textContent = avgWeightNegative;
            document.getElementById('totalAvgAmountNegative').textContent = avgAmountNegative;

            document.getElementById('totalAverages').style.display = 'block';
        }

        async function fetchData(startDate, endDate) {
            try {
                const startTimestamp = Timestamp.fromDate(new Date(startDate));
                const endTimestamp = Timestamp.fromDate(new Date(endDate));
                const adjustedEndTimestamp = new Timestamp(endTimestamp.seconds + 86399, endTimestamp.nanoseconds);

                const ordersQuery = query(
                    collection(db, "orders"),
                    where("timestamp", ">=", startTimestamp),
                    where("timestamp", "<=", adjustedEndTimestamp)
                );

                const querySnapshot = await getDocs(ordersQuery);

                if (querySnapshot.empty) {
                    alert("No orders found for the selected date range.");
                    return;
                }

                reportBody.innerHTML = '';
                const filteredOrders = [];

                querySnapshot.forEach(doc => {
                    const orderData = doc.data();

                    // Only include orders that do not have both "Acc" and "Covered" checked
                    if (!(orderData.accChecked && orderData.coveredChecked)) {
                        filteredOrders.push(orderData);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${orderData.timestamp.toDate().toLocaleDateString('en-GB')}</td>
                            <td>${orderData.name}</td>
                            <td>${orderData.weight}</td>
                            <td>${orderData.rate}</td>
                            <td>${orderData.amount}</td>
                            <td class="checkbox-column">
                                <input type="checkbox" class="acc-checkbox" ${orderData.accChecked ? 'checked' : ''} />
                            </td>
                            <td class="checkbox-column">
                                <input type="checkbox" class="covered-checkbox" ${orderData.coveredChecked ? 'checked' : ''} />
                            </td>
                        `;
                        reportBody.appendChild(row);

                        // Highlight rows based on checkbox state
                        const accCheckbox = row.querySelector('.acc-checkbox');
                        const coveredCheckbox = row.querySelector('.covered-checkbox');

                        if (orderData.accChecked) row.classList.add('highlight-acc');
                        if (orderData.coveredChecked) row.classList.add('highlight-covered');

                        accCheckbox.addEventListener('change', function () {
                            if (!accCheckbox.checked) {
                                const confirmUncheck = confirm("Are you sure you want to uncheck 'Acc'? This will move the order back to the regular orders table.");
                                if (!confirmUncheck) {
                                    accCheckbox.checked = true; // Revert to checked state
                                    return;
                                }
                            }
                            if (accCheckbox.checked) row.classList.add('highlight-acc');
                            else row.classList.remove('highlight-acc');
                            updateCheckedStatus(doc.id, 'accChecked', accCheckbox.checked);
                        });

                        coveredCheckbox.addEventListener('change', function () {
                            if (!coveredCheckbox.checked) {
                                const confirmUncheck = confirm("Are you sure you want to uncheck 'Covered'? This will move the order back to the regular orders table.");
                                if (!confirmUncheck) {
                                    coveredCheckbox.checked = true; // Revert to checked state
                                    return;
                                }
                            }
                            if (coveredCheckbox.checked) row.classList.add('highlight-covered');
                            else row.classList.remove('highlight-covered');
                            updateCheckedStatus(doc.id, 'coveredChecked', coveredCheckbox.checked);
                        });
                    }
                });

                displayTotalAverages(filteredOrders);
                reportTable.style.display = 'block';
            } catch (error) {
                console.error("Error fetching data: ", error);
            }
        }

        function updateCheckedStatus(docId, field, value) {
            const docRef = doc(db, "orders", docId);
            updateDoc(docRef, {
                [field]: value
            }).then(() => {
                console.log(`Updated ${field} for document ${docId}`);
            }).catch((error) => {
                console.error(`Error updating ${field}:`, error);
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
